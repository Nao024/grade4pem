# -*- coding: utf-8 -*-
"""pem10232.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/13cc15kk9gyOcKOmNePF5uHWBE3__NcZJ
"""

# -*- coding: utf-8 -*-
import streamlit as st
import os
import json
from datetime import datetime
from openai import OpenAI

# ========== åˆæœŸè¨­å®š ==========
client = OpenAI(api_key="APIã‚­ãƒ¼å…¥åŠ›")
USER_FILE = "users.json"
LOG_DIR = "logs"
os.makedirs(LOG_DIR, exist_ok=True)

# ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ==========
def load_users():
    if os.path.exists(USER_FILE):
        with open(USER_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}

def save_users(users):
    with open(USER_FILE, "w", encoding="utf-8") as f:
        json.dump(users, f, indent=2, ensure_ascii=False)

# ========== ãƒ­ã‚°è¨˜éŒ² ==========
def write_log(message):
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    log_path = os.path.join(LOG_DIR, "IDlogin.txt")
    with open(log_path, "a", encoding="utf-8") as f:
        f.write(f"[{now}] {message}\n")

# ========== ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ ==========
if "page" not in st.session_state:
    st.session_state.page = "login"
if "user_id" not in st.session_state:
    st.session_state.user_id = None

users = load_users()

def login_page():
    st.title("ğŸ” ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸")

    # ãã‚Œãã‚Œã«ä¸€æ„ã®ã‚­ãƒ¼ã‚’ä»˜ä¸
    id_input = st.text_input("ãƒ¦ãƒ¼ã‚¶ãƒ¼ID", key="login_id_input")
    pw_input = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password", key="login_pw_input")

    if st.button("ãƒ­ã‚°ã‚¤ãƒ³", key="login_button"):
        if id_input in users and users[id_input] == pw_input:
            st.session_state.page = "main"
            st.session_state.user_id = id_input
            write_log(f"ãƒ­ã‚°ã‚¤ãƒ³: {id_input}")
            st.success(f"{id_input} ã•ã‚“ã€ã‚ˆã†ã“ãï¼")
            st.rerun()
        else:
            st.error("IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚")

    st.markdown("---")
    if st.button("åˆå›ç™»éŒ²", key="to_register_button"):
        st.session_state.page = "register"
        st.rerun()



def register_page():
    st.title("ğŸ“ åˆå›ç™»éŒ²ãƒšãƒ¼ã‚¸")

    # ã“ã¡ã‚‰ã‚‚ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ä»˜ä¸
    new_id = st.text_input("æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›", key="register_id_input")
    new_pw = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›", type="password", key="register_pw_input")

    if st.button("ç™»éŒ²", key="register_button"):
        if new_id in users:
            st.error("ã“ã®IDã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚")
        elif not new_id or not new_pw:
            st.error("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        else:
            users[new_id] = new_pw
            save_users(users)
            st.success("ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚")
            st.session_state.page = "login"
            st.rerun()

    if st.button("ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹", key="to_login_button"):
        st.session_state.page = "login"
        st.rerun()


# ========== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªï¼ˆæ—¢å­˜ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‰ ==========
def main_page():
    st.sidebar.write(f"ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­: {st.session_state.user_id}")
    if st.sidebar.button("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ"):
        write_log(f"ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ: {st.session_state.user_id}")
        st.session_state.page = "login"
        st.session_state.user_id = None
        st.warning("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚")
        st.rerun()

    st.title("AIã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚¨ãƒ©ãƒ¼è¨ºæ–­ãƒ„ãƒ¼ãƒ«")

    # --- å…¥åŠ›ã‚¨ãƒªã‚¢ ---
    st.header("â‘  ãƒ•ã‚¡ã‚¤ãƒ«ã¨æƒ…å ±ã®å…¥åŠ›")
    program = st.file_uploader("Javaãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆ.javaï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["java"], accept_multiple_files=True)
    testcase = st.file_uploader("ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆä»»æ„ï¼‰", type=["java"], accept_multiple_files=True)
    pem_text = st.text_area("PEMã®å†…å®¹ï¼ˆä»»æ„ï¼‰ï¼šå®Ÿè¡Œçµæœã‚„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›")

    # --- æ¡ä»¶é¸æŠ ---
    st.header("â‘¡ æ¡ä»¶ã‚’é¸æŠ")
    test_opt = st.radio("ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æœ‰ç„¡", ["ã‚ã‚Š", "ãªã—"], horizontal=True)
    error_opt = st.selectbox("æŒ‡æ‘˜ã™ã‚‹ã‚¨ãƒ©ãƒ¼æ•°", ["ï¼‘ã¤ã ã‘", "ã§ãã‚‹ã ã‘ãŸãã•ã‚“", "æŒ‡å®šãªã—"])
    level_opt = st.radio("è§£èª¬ãƒ¬ãƒ™ãƒ«", ["åˆç´š", "ä¸­ç´š", "ä¸Šç´š"], horizontal=True)

    # --- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ ---
    def build_prompt(tcase, err, level):
        common = "æ¬¡ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã¤ã„ã¦ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒæˆåŠŸã™ã‚‹ã‚ˆã†ã«ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£æ–¹æ³•ã‚’"
        audience = {"åˆç´š": "å°‚é–€ç”¨èªã‚’ä½¿ã‚ãšã«", "ä¸­ç´š": "å¤§å­¦ç”Ÿå‘ã‘ã«", "ä¸Šç´š": "æŠ€è¡“çš„ã«è©³ã—ã"}
        target = audience[level]

        prompt = f"{common}{target}èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
        if err == "ï¼‘ã¤ã ã‘":
            prompt += "ã‚¨ãƒ©ãƒ¼ãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ã€æœ€ã‚‚é‡è¦ãªã‚‚ã®ã‚’1ã¤æŒ™ã’ã¦ãã ã•ã„ã€‚"
        elif err == "ã§ãã‚‹ã ã‘ãŸãã•ã‚“":
            prompt += "ä¿®æ­£ç®‡æ‰€ã‚’ã§ãã‚‹ã ã‘å¤šãæŒ™ã’ã¦ãã ã•ã„ã€‚"
        if tcase == "ã‚ã‚Š":
            prompt += "ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®çµæœã‚‚å…¨ã¦è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚"
        return prompt

    selected_prompt = build_prompt(test_opt, error_opt, level_opt)

    # --- å‡ºåŠ› ---
    st.header("â‘¢ é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ")
    st.code(selected_prompt, language="markdown")

    # --- å®Ÿè¡Œãƒœã‚¿ãƒ³ ---
    if st.button("AIã«é€ä¿¡"):
        if not program:
            st.error("Javaãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
        else:
            write_log(f"å®Ÿè¡Œ: {st.session_state.user_id} ãŒAIè¨ºæ–­ã‚’å®Ÿè¡Œ")
            st.success("ä»¥ä¸‹ã®æ¡ä»¶ã§AIã«é€ä¿¡ã—ã¾ã—ãŸã€‚")
            st.write({
                "ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹": test_opt,
                "æŒ‡æ‘˜æ•°": error_opt,
                "è§£èª¬ãƒ¬ãƒ™ãƒ«": level_opt
            })
            st.write("ä½¿ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:")
            st.code(selected_prompt, language="markdown")

            st.info("AIãŒè§£æä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„â€¦")

            program_text = "".join(f"\n\nã€{p.name}ã€‘\n{p.read().decode('utf-8')}" for p in program)
            testcase_text = "".join(f"\n\nã€{t.name}ã€‘\n{t.read().decode('utf-8')}" for t in testcase) if testcase else ""
            pem_info = f"\n\nã€PEMå†…å®¹ã€‘\n{pem_text}" if pem_text else ""

            full_prompt = f"{selected_prompt}\n\nã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€‘\n{program_text}\n\nã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã€‘\n{testcase_text}{pem_info}"

            try:
                response = client.chat.completions.create(
                    model="gpt-5",
                    messages=[
                        {"role": "system", "content": "ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸJavaè¬›å¸«ã§ã™ã€‚"},
                        {"role": "user", "content": full_prompt}
                    ]
                )

                result = response.choices[0].message.content
                st.success(" AIã®è§£æãŒå®Œäº†ã—ã¾ã—ãŸï¼")
                st.subheader("â‘£ AIã®è§£æçµæœ")
                st.markdown(result)

                # --- ãƒ­ã‚°è¨˜éŒ²ï¼ˆè§£æçµæœã‚‚ï¼‰ ---
                log_path = os.path.join(LOG_DIR, f"{datetime.now().strftime('%Y%m%d_%H%M%S')}_{st.session_state.user_id}.txt")
                with open(log_path, "w", encoding="utf-8") as f:
                    f.write(f"[ãƒ¦ãƒ¼ã‚¶ãƒ¼]: {st.session_state.user_id}\n")
                    f.write(f"[æ—¥æ™‚]: {datetime.now()}\n\n")
                    f.write("=== å…¥åŠ›æƒ…å ± ===\n")
                    program_names = [p.name for p in program] if program else []
                    test_names = [t.name for t in testcase] if testcase else []
                    f.write(f"[ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒ•ã‚¡ã‚¤ãƒ«]: {', '.join(program_names)}\n")
                    f.write(f"[ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«]: {', '.join(test_names) or 'ãªã—'}\n")
                    f.write(f"PEM:\n{pem_text}\n\n")
                    f.write(f"[ãƒ—ãƒ­ã‚°ãƒ©ãƒ ]: {', '.join(program_names)} \n")
                    f.write(f"[ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹]: {', '.join(test_names)}\n" )
                    f.write(f"[ãƒ†ã‚¹ãƒˆæœ‰ç„¡]: {test_opt}\n")
                    f.write(f"[ã‚¨ãƒ©ãƒ¼æ•°æŒ‡å®š]: {error_opt}\n")
                    f.write(f"[è§£èª¬ãƒ¬ãƒ™ãƒ«]: {level_opt}\n")
                    f.write("=== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ===\n")
                    f.write(f"{selected_prompt}\n\n")
                    f.write("=== è§£æçµæœ ===\n")
                    f.write(result)

            except Exception as e:
                st.error(f"AIè§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# ========== ãƒšãƒ¼ã‚¸é·ç§»åˆ¶å¾¡ ==========
if st.session_state.page == "login":
    login_page()
elif st.session_state.page == "register":
    register_page()
elif st.session_state.page == "main":
    main_page()

USER_FILE = "users.json"
LOG_DIR = "logs"
os.makedirs(LOG_DIR, exist_ok=True)